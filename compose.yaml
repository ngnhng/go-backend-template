# Copyright 2025 Nguyen Nhat Nguyen
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
volumes:
  prometheus_data: {}
  clickhouse_data: {}
  clickhouse_logs: {}
  coroot_data: {}
  node_agent_data: {}
  cluster_agent_data: {}
  pg18-primary-data: {}
  pg18-replica-data: {}

services:
  app:
    build:
      context: .
      dockerfile: ./deployment/local/app/Dockerfile
      target: app-local
    restart: "no"
    shm_size: 256mb
    environment:
      OTEL_SERVICE_NAME: "my-app"
      OTEL_EXPORTER_OTLP_TRACES_INSECURE: "true"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "http://coroot:4317"
      OTEL_EXPORTER_OTLP_LOGS_ENDPOINT: "http://coroot:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      POSTGRES_PRIMARY_HOST: "postgres-primary"
      POSTGRES_PRIMARY_PORT: "5432"
      POSTGRES_REPLICA_0_HOST: "postgres-replica"
      POSTGRES_REPLICA_0_PORT: "5432"
    ports:
      - "8080:8080"
    depends_on:
      - postgres-primary
      - postgres-replica
    profiles:
      - app
      - all
  # --- Application dependencies ---
  postgres-primary:
    image: postgres:18-alpine
    restart: "no"
    shm_size: 128mb
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PRIMARY_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    command: >
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c max_connections=200
    volumes:
      - pg18-primary-data:/var/lib/postgresql
      - ./deployment/local/postgres18:/docker-entrypoint-initdb.d
    profiles:
      - postgres
      - infra
      - all

  postgres-replica:
    user: root
    image: postgres:18-alpine
    restart: "no"
    shm_size: 128mb
    depends_on:
      - postgres-primary
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_REPLICA_0_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/18/docker
      # used by pg_isready / pg_basebackup for repl_user
      PGPASSWORD: repl_password
    command:
      - sh
      - -c
      - |
        set -e

        # If already initialized, just start as standby
        if [ -s "$$PGDATA/PG_VERSION" ]; then
          echo "Replica already initialized, starting..."
          exec gosu postgres postgres
        fi

        echo "Initializing replica data directory at $$PGDATA"
        mkdir -p "$$PGDATA"
        chown -R postgres:postgres /var/lib/postgresql
        chmod 700 "$$PGDATA"

        echo "Waiting for primary to accept connections..."
        until pg_isready -h postgres-primary -p 5432 >/dev/null 2>&1; do
          echo "  ... still waiting"
          sleep 1
        done

        echo "Running pg_basebackup from primary..."
        gosu postgres pg_basebackup -h postgres-primary -p 5432 -D "$$PGDATA" -U repl_user -Fp -Xs -P -R

        echo "Starting replica PostgreSQL..."
        exec gosu postgres postgres -c max_connections=200
    volumes:
      - pg18-replica-data:/var/lib/postgresql
    profiles:
      - postgres
      - infra
      - all

  # --- Observability ---
  coroot:
    restart: no
    image: ghcr.io/coroot/coroot${LICENSE_KEY:+-ee} # set 'coroot-ee' as the image if LICENSE_KEY is defined
    pull_policy: if_not_present
    user: root
    volumes:
      - coroot_data:/data
    ports:
      - 8082:8080
    command:
      - "--data-dir=/data"
      - "--bootstrap-prometheus-url=http://prometheus:9090"
      - "--bootstrap-refresh-interval=15s"
      - "--bootstrap-clickhouse-address=clickhouse:9000"
    environment:
      - LICENSE_KEY=${LICENSE_KEY:-}
    depends_on:
      - clickhouse
      - prometheus
    profiles:
      - observability
      - all

  node-agent:
    restart: no
    image: ghcr.io/coroot/coroot-node-agent
    pull_policy: if_not_present
    privileged: true
    pid: "host"
    volumes:
      - /sys/kernel/tracing:/sys/kernel/tracing
      - /sys/kernel/debug:/sys/kernel/debug
      - /sys/fs/cgroup:/host/sys/fs/cgroup
      - node_agent_data:/data
    command:
      - "--collector-endpoint=http://coroot:8080"
      - "--cgroupfs-root=/host/sys/fs/cgroup"
      - "--wal-dir=/data"
    profiles:
      - observability
      - all

  cluster-agent:
    restart: no
    image: ghcr.io/coroot/coroot-cluster-agent
    pull_policy: if_not_present
    volumes:
      - cluster_agent_data:/data
    command:
      - "--coroot-url=http://coroot:8080"
      - "--metrics-scrape-interval=15s"
      - "--metrics-wal-dir=/data"
    depends_on:
      - coroot
    profiles:
      - observability
      - all

  prometheus:
    restart: no
    image: prom/prometheus:v2.53.5
    volumes:
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--web.enable-remote-write-receiver"
    ports:
      - "127.0.0.1:9090:9090"
    profiles:
      - observability
      - all

  clickhouse:
    restart: no
    image: clickhouse/clickhouse-server:24.3
    environment:
      CLICKHOUSE_SKIP_USER_SETUP: "1"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    ports:
      - "127.0.0.1:9000:9000"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    profiles:
      - observability
      - all
