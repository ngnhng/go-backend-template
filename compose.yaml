# Copyright 2025 Nguyen Nhat Nguyen
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
volumes:
  grafana_data: {}
  pg18-primary-data: {}
  pg18-replica-data: {}
  node_agent_data: {}
  tempo_data: {}
  vm_data: {}

services:
  profile-api:
    build:
      context: .
      dockerfile: ./deployment/local/profile-api/Dockerfile
      target: app-local
    restart: "no"
    shm_size: 256mb
    environment:
      OTEL_SERVICE_NAME: "profile-api"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=local,service.version=dev"
      OTEL_EXPORTER_OTLP_TRACES_INSECURE: "true"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "http://otel-collector:4317"
      OTEL_EXPORTER_OTLP_LOGS_ENDPOINT: "http://otel-collector:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      POSTGRES_PRIMARY_HOST: "postgres-primary"
      POSTGRES_PRIMARY_PORT: "5432"
      POSTGRES_PRIMARY_DATABASE: "profiledb"
      POSTGRES_REPLICA_0_HOST: "postgres-replica"
      POSTGRES_REPLICA_0_PORT: "5432"
      POSTGRES_REPLICA_0_DATABASE: "profiledb"
    ports:
      - "8080:8080"
    depends_on:
      - postgres-primary
      - postgres-replica
    profiles:
      - profile-api
      - all
  # --- Application dependencies ---
  postgres-primary:
    image: postgres:18-alpine
    restart: "no"
    shm_size: 128mb
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PRIMARY_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    command: >
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c max_connections=200
    volumes:
      - pg18-primary-data:/var/lib/postgresql
      - ./deployment/local/postgres18:/docker-entrypoint-initdb.d
    profiles:
      - postgres
      - infra
      - all

  postgres-replica:
    image: postgres:18-alpine
    restart: "no"
    shm_size: 128mb
    depends_on:
      - postgres-primary
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_REPLICA_0_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/18/docker
      # used by pg_isready / pg_basebackup for repl_user
      PGPASSWORD: repl_password
    command:
      - sh
      - -c
      - |
        set -e

        # If already initialized, just start as standby
        if [ -s "$$PGDATA/PG_VERSION" ]; then
          echo "Replica already initialized, starting..."
          exec gosu postgres postgres
        fi

        echo "Initializing replica data directory at $$PGDATA"
        mkdir -p "$$PGDATA"
        chown -R postgres:postgres /var/lib/postgresql
        chmod 700 "$$PGDATA"

        echo "Waiting for primary to accept connections..."
        until pg_isready -h postgres-primary -p 5432 >/dev/null 2>&1; do
          echo "  ... still waiting"
          sleep 1
        done

        echo "Running pg_basebackup from primary..."
        gosu postgres pg_basebackup -h postgres-primary -p 5432 -D "$$PGDATA" -U repl_user -Fp -Xs -P -R

        echo "Starting replica PostgreSQL..."
        exec gosu postgres postgres -c max_connections=200
    volumes:
      - pg18-replica-data:/var/lib/postgresql
    profiles:
      - postgres
      - infra
      - all

  # --- Observability ---
  tempo:
    image: grafana/tempo
    restart: unless-stopped
    command:
      - -config.file=/etc/tempo/config.yaml
    volumes:
      - ./deployment/local/tempo/config.yaml:/etc/tempo/config.yaml:ro
      - tempo_data:/var/tempo
    ports:
      - "3200:3200"
    profiles:
      - observability
      - all

  grafana:
    image: grafana/grafana
    restart: no
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Admin"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deployment/local/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./deployment/local/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    ports:
      - "3000:3000"
    profiles:
      - observability
      - all

  node-agent:
    restart: no
    image: ghcr.io/coroot/coroot-node-agent
    pull_policy: if_not_present
    privileged: true
    pid: "host"
    volumes:
      - /sys/kernel/tracing:/sys/kernel/tracing
      - /sys/kernel/debug:/sys/kernel/debug
      - /sys/fs/cgroup:/host/sys/fs/cgroup
      - node_agent_data:/data
    command:
      - "--listen=0.0.0.0:8000"
      - "--cgroupfs-root=/host/sys/fs/cgroup"
      - "--wal-dir=/data"
    profiles:
      - observability
      - all

  victoria-metrics:
    image: victoriametrics/victoria-metrics
    command:
      - --storageDataPath=/vm-data
      - --retentionPeriod=15d
    ports:
      - "8428:8428"
    volumes:
      - vm_data:/vm-data

  vmagent:
    image: victoriametrics/vmagent
    command:
      - -promscrape.config=/etc/prometheus/prometheus.yml
      - -remoteWrite.url=http://victoria-metrics:8428/api/v1/write
    volumes:
      - ./deployment/local/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - victoria-metrics
      - node-agent

  vmalert:
    image: victoriametrics/vmalert
    command:
      - -rule=/etc/vmalert/coroot-rules.yml
      - -datasource.url=http://victoria-metrics:8428
      - -remoteWrite.url=http://victoria-metrics:8428
      - -evaluationInterval=15s
    volumes:
      - ./deployment/local/vmalert/coroot-rules.yml:/etc/vmalert/coroot-rules.yml:ro
    depends_on:
      - victoria-metrics
