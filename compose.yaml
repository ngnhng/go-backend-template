# Copyright 2025 Nguyen Nhat Nguyen
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
volumes:
  grafana_data: {}
  grafana_plugins: {}
  pg18-primary-data: {}
  pg18-replica-data: {}
  node_agent_data: {}
  tempo_data: {}
  vm_data: {}
  vlogs_data: {}
  vt_data: {}

networks:
  app:
  observability:

services:
  profile-api:
    build:
      context: .
      dockerfile: ./deployment/local/profile-api/Dockerfile
    restart: "no"
    shm_size: 256mb
    logging:
      driver: fluentd
      options:
        fluentd-address: fluent-bit:24224
        fluentd-async: "true"
        tag: profile-api
    environment:
      # --- OTel resource ---
      OTEL_SERVICE_NAME: "profile-api"
      OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=local,service.version=dev"

      # --- Auto-instrumentation detection (telemetry.Init) ---
      OTEL_GO_AUTO_TARGET_EXE: "profile-api"

      # --- Send ALL OTLP to the Collector (K8s-style gateway pattern) ---
      # Traces (gRPC)
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_EXPORTER_OTLP_ENDPOINT: "otel-collector:4317"

      # Metrics
      OTEL_METRICS_EXPORTER: "otlp"
      OTEL_EXPORTER_OTLP_METRICS_PROTOCOL: "http/protobuf"
      OTEL_EXPORTER_OTLP_METRICS_ENDPOINT: "http://otel-collector:4318/v1/metrics"
      OTEL_EXPORTER_OTLP_METRICS_INSECURE: "true"

      # Logs via OTLP HTTP (if we wire otel logs exporter in Go)
      OTEL_LOGS_EXPORTER: "otlp"
      OTEL_EXPORTER_OTLP_LOGS_PROTOCOL: "http/protobuf"
      OTEL_EXPORTER_OTLP_LOGS_ENDPOINT: "http://otel-collector:4318/v1/logs"

      # --- App deps ---
      POSTGRES_PRIMARY_HOST: "postgres-primary"
      POSTGRES_PRIMARY_PORT: "5432"
      POSTGRES_PRIMARY_DATABASE: "profiledb"
      POSTGRES_REPLICA_0_HOST: "postgres-replica"
      POSTGRES_REPLICA_0_PORT: "5432"
      POSTGRES_REPLICA_0_DATABASE: "profiledb"
      HMAC_SECRET: "secret"
    networks:
      - app
      - observability
    ports:
      - "8080:8080"
    depends_on:
      - postgres-primary
    profiles:
      - app
      - all

  # The Auto-Instrumentation Agent (Sidecar)
  otel-agent:
    image: ghcr.io/open-telemetry/opentelemetry-go-instrumentation/autoinstrumentation-go:latest
    privileged: true # Required for eBPF
    pid: "service:profile-api" # Share PID namespace with the app
    environment:
      - OTEL_GO_AUTO_TARGET_EXE=/profile-api
      - OTEL_SERVICE_NAME=profile-api
      # Sidecar also sends to the Collector, not directly to VictoriaTraces
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_EXPORTER_OTLP_ENDPOINT=otel-collector:4317
    networks:
      - app
      - observability
    profiles:
      - sidecar
      - all

  # --- Application dependencies ---
  postgres-primary:
    image: postgres:18-alpine
    restart: "no"
    shm_size: 128mb
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PRIMARY_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    command: >
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
      -c max_connections=100
    volumes:
      - pg18-primary-data:/var/lib/postgresql
      - ./deployment/local/postgres18:/docker-entrypoint-initdb.d
    networks:
      - app
    profiles:
      - postgres
      - infra
      - all

  postgres-replica:
    image: postgres:18-alpine
    restart: "no"
    shm_size: 128mb
    depends_on:
      - postgres-primary
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_REPLICA_0_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/18/docker
      # used by pg_isready / pg_basebackup for repl_user
      PGPASSWORD: repl_password
    command:
      - sh
      - -c
      - |
        set -e

        # If already initialized, just start as standby
        if [ -s "$$PGDATA/PG_VERSION" ]; then
          echo "Replica already initialized, starting..."
          exec gosu postgres postgres
        fi

        echo "Initializing replica data directory at $$PGDATA"
        mkdir -p "$$PGDATA"
        chown -R postgres:postgres /var/lib/postgresql
        chmod 700 "$$PGDATA"

        echo "Waiting for primary to accept connections..."
        until pg_isready -h postgres-primary -p 5432 >/dev/null 2>&1; do
          echo "  ... still waiting"
          sleep 1
        done

        echo "Running pg_basebackup from primary..."
        gosu postgres pg_basebackup -h postgres-primary -p 5432 -D "$$PGDATA" -U repl_user -Fp -Xs -P -R

        echo "Starting replica PostgreSQL..."
        exec gosu postgres postgres -c max_connections=200
    networks:
      - app
    volumes:
      - pg18-replica-data:/var/lib/postgresql
    profiles:
      - postgres
      - infra
      - all

  # --- Observability ---

  # Central OTEL gateway (like a K8s "otel-collector" in observability ns)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./deployment/local/otel-collector/config.yaml:/etc/otelcol/config.yaml:ro
    depends_on:
      - victoria-metrics
      - victoria-traces
      - victoria-logs
    networks:
      - observability
    profiles:
      - observability
      - all

  grafana:
    image: grafana/grafana
    restart: no
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Admin"
      GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS: "victoriametrics-logs-datasource,grafana-metricsdrilldown-app,grafana-lokiexplore-app"
      GF_PLUGINS_PREINSTALL_SYNC: "victoriametrics-logs-datasource"
      GF_LOG_LEVEL: info
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_plugins:/var/lib/grafana/plugins
      - ./deployment/local/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./deployment/local/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./deployment/local/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - victoria-traces
      - victoria-logs
      - victoria-metrics
    ports:
      - "3000:3000"
    networks:
      - observability
    profiles:
      - observability
      - all

  node-agent:
    restart: no
    image: ghcr.io/coroot/coroot-node-agent
    pull_policy: if_not_present
    privileged: true
    pid: "host"
    volumes:
      - /sys/kernel/tracing:/sys/kernel/tracing
      - /sys/kernel/debug:/sys/kernel/debug
      - /sys/fs/cgroup:/host/sys/fs/cgroup
      - node_agent_data:/data
    command:
      - "--listen=0.0.0.0:8000"
      - "--cgroupfs-root=/host/sys/fs/cgroup"
      - "--wal-dir=/data"
    networks:
      - observability
    profiles:
      - observability
      - all

  victoria-metrics:
    image: victoriametrics/victoria-metrics
    command:
      - --storageDataPath=/vm-data
      - --retentionPeriod=15d
      - --opentelemetry.usePrometheusNaming
    ports:
      - "8428:8428"
    networks:
      - observability
    volumes:
      - vm_data:/vm-data
    profiles:
      - observability
      - all

  vmagent:
    image: victoriametrics/vmagent
    command:
      - -promscrape.config=/etc/prometheus/prometheus.yml
      - -remoteWrite.url=http://victoria-metrics:8428/api/v1/write
    volumes:
      - ./deployment/local/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - victoria-metrics
      - node-agent
    networks:
      - observability
    profiles:
      - observability
      - all

  vmalert:
    image: victoriametrics/vmalert
    command:
      - -rule=/etc/vmalert/coroot-rules.yml
      - -datasource.url=http://victoria-metrics:8428
      - -remoteWrite.url=http://victoria-metrics:8428
      - -evaluationInterval=15s
    volumes:
      - ./deployment/local/vmalert/coroot-rules.yml:/etc/vmalert/coroot-rules.yml:ro
    depends_on:
      - victoria-metrics
    networks:
      - observability
    profiles:
      - observability
      - all

  victoria-logs:
    image: victoriametrics/victoria-logs:latest
    command:
      - "-storageDataPath=/vlogs-data"
      - "-retentionPeriod=1d"
    ports:
      - "9428:9428"
    volumes:
      - vlogs_data:/vlogs-data
    networks:
      - observability
    profiles:
      - observability
      - all

  victoria-traces:
    image: victoriametrics/victoria-traces:latest
    command:
      - "-httpListenAddr=:8429"
      - "-otlpGRPCListenAddr=:4317"
      - "-otlpGRPC.tls=false"
      - "-storageDataPath=/vt-data"
      - "-retentionPeriod=1d"
    ports:
      - "8429:8429" # UI and Jaeger Query API
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    networks:
      - observability
    volumes:
      - vt_data:/vt-data
    profiles:
      - observability
      - all

  fluent-bit:
    image: fluent/fluent-bit:latest
    volumes:
      - ./deployment/local/fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
    ports:
      - "24224:24224" # Listens for Docker logs
      - "24224:24224/udp"
    depends_on:
      - victoria-logs
    networks:
      - observability
    profiles:
      - observability
      - all
